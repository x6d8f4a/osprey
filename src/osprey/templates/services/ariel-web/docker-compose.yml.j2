services:
  ariel-web:
    container_name: ariel-web
    labels:
      osprey.project.name: "{{ osprey_labels.project_name }}"
      osprey.project.root: "{{ osprey_labels.project_root }}"
      osprey.deployed.at: "{{ osprey_labels.deployed_at }}"
    build:
      context: ./ariel-web
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "{{ deployment.bind_address | default('127.0.0.1') }}:{{ services.ariel_web.port_host | default(8085) }}:8085"
    environment:
      # Timezone synchronization with host
      - TZ={{ system.timezone }}
      # Config file location
      - CONFIG_FILE=/app/config.yml
      # Development mode flag for local osprey override
      - DEV_MODE=${DEV_MODE:-false}
      # Override database host for Docker networking (localhost -> service name)
      - ARIEL_DATABASE_HOST=postgresql
      # LLM API keys (pass through from host)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - CBORG_API_KEY=${CBORG_API_KEY:-}
      - STANFORD_API_KEY=${STANFORD_API_KEY:-}
      - ARGO_API_KEY=${ARGO_API_KEY:-}
      # Ollama host for local embeddings (host.docker.internal for Docker Desktop)
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
    volumes:
      # Mount config.yml for ARIEL configuration
      - {{ project_root }}/config.yml:/app/config.yml:ro
      # Mount build directory for dev mode osprey wheel override
      - ./ariel-web:/app/build:ro
    networks:
      - osprey-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      postgresql:
        condition: service_healthy

networks:
  osprey-network:
