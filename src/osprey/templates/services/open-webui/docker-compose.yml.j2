volumes:
  open-webui:

services:
  open-webui:
    container_name: open-webui
    labels:
      osprey.project.name: "{{ osprey_labels.project_name }}"
      osprey.project.root: "{{ osprey_labels.project_root }}"
      osprey.deployed.at: "{{ osprey_labels.deployed_at }}"
    build:
      context: ./open-webui
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "{{ deployment.bind_address | default('127.0.0.1') }}:{{services.open_webui.port_host}}:{{services.open_webui.port_container}}"
    environment:
      # Timezone synchronization with host (from system configuration)
      - TZ={{system.timezone}}

      # ==== API CONNECTIONS (Auto-configured) ====
      # Ollama API (for model hosting)
      # Note: Use host.docker.internal on macOS/Windows, host.containers.internal on Linux/Podman
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - OLLAMA_BASE_URLS=http://host.docker.internal:11434

      # OpenAI API (Pipelines + response model provider for background tasks)
      - OPENAI_API_BASE_URLS=http://pipelines:9099;{{api.providers[models.response.provider].base_url}}
      - OPENAI_API_KEYS=0p3n-w3bu!;${{ '{' }}{{ models.response.provider | upper }}_API_KEY{{ '}' }}

      # ==== BACKGROUND TASK MODEL ====
      # Route Open WebUI background tasks (title, tags, follow-up generation)
      # to a direct LLM call instead of the Osprey pipeline.
      # Uses the 'response' model from config.yml (fast & cheap)
      - TASK_MODEL_EXTERNAL={{ models.response.model_id }}

      # ==== AUTHENTICATION ====
      # Disable auth for local development (no login required)
      - WEBUI_AUTH=false

      # ==== UI CUSTOMIZATION ====
      - WEBUI_CUSTOM_CSS_URL=/static/custom.css
      - USER_MEMORY_DIR=/app/{{file_paths.user_memory_dir}}

      # Proxy settings (optional - uncomment if behind corporate firewall)
      # - NO_PROXY=${NO_PROXY}
    volumes:
      - open-webui:/app/backend/data
      - {{project_root}}/{{file_paths.agent_data_dir}}:/app/backend/open_webui/static/agent_data:ro
      - ./open-webui/custom.css:/app/backend/static/custom.css
      - {{project_root}}/config.yml:/app/config.yml:ro
      - {{project_root}}/src:/app/src:ro
    networks:
      - osprey-network
