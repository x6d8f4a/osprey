"""
Current Weather Capability - Hello World Weather Tutorial

Retrieves current weather conditions for a location using a mock weather service.
Demonstrates essential capability patterns including:
- Location extraction from user queries
- External service integration (mock API)
- Context creation and state management
- Error handling and retry policies
- Orchestrator and classifier guidance

Supports San Francisco, New York, Prague, and defaults to local weather.
"""

import asyncio
import logging
from typing import Dict, Any, Optional
from pydantic import BaseModel, Field

from osprey.base import (
    BaseCapability, capability_node,
    OrchestratorGuide, OrchestratorExample, PlannedStep,
    ClassifierActions, ClassifierExample, TaskClassifierGuide
)
from osprey.base.errors import ErrorClassification, ErrorSeverity
from osprey.models import get_chat_completion
from osprey.registry import get_registry
from osprey.state import AgentState, StateManager
from osprey.utils.config import get_model_config

from {{ package_name }}.context_classes import CurrentWeatherContext
from {{ package_name }}.mock_weather_api import weather_api

logger = logging.getLogger(__name__)


# =============================================================================
# Private Helper: LLM-based Location Extraction
# =============================================================================

class _ParsedWeatherQuery(BaseModel):
    """Internal model for parsed weather query location."""
    location: str = Field(
        description=(
            "The location for which weather is requested. "
            "Can be a city name like 'San Francisco', 'New York', 'Prague', "
            "or 'local' if no specific location was mentioned in the query."
        )
    )


async def _parse_location_from_query(query: str) -> str:
    """
    Extract location from weather query using LLM.

    Private helper function that uses structured output to parse location
    from natural language queries. Handles variations, nicknames, and
    defaults to "local" when no location is specified.

    Args:
        query: User's weather query

    Returns:
        Extracted location string (or "local" as fallback)
    """
    # Clear, example-driven prompt for reliable location extraction
    prompt = f"""You are a location extraction assistant. Extract the location from weather queries.

Task: Given a weather query, extract the location name.

Rules:
1. If a city is mentioned explicitly, return the city name in title case
2. Recognize common nicknames and abbreviations:
   - "Big Apple", "NYC" → "New York"
   - "SF", "Bay Area" → "San Francisco"
   - "Praha" → "Prague"
3. If NO location is mentioned, return exactly "local" (lowercase)
4. If multiple locations appear, return the primary one being asked about

Examples:
- Query: "What's the weather in Paris?" → location: "Paris"
- Query: "How's it in the Big Apple?" → location: "New York"
- Query: "Is it nice in SF?" → location: "San Francisco"
- Query: "What's the weather like?" → location: "local"
- Query: "Should I bring an umbrella?" → location: "local"

Now extract the location from this query:
Query: "{query}"

Return ONLY the location name (or "local" if no location mentioned)."""

    model_config = get_model_config("orchestrator")

    try:
        logger.debug(f"Parsing location from query: {query}")

        # Set caller context for API call logging (propagates through asyncio.to_thread)
        from osprey.models import set_api_call_context

        set_api_call_context(
            function="_parse_location_from_query",
            module="current_weather",
            class_name="CurrentWeatherCapability",
            extra={"capability": "current_weather", "stage": "location_parsing"},
        )

        parsed_result = await asyncio.to_thread(
            get_chat_completion,
            message=prompt,
            model_config=model_config,
            output_model=_ParsedWeatherQuery,
            max_tokens=50,  # Only need a location name
            temperature=0.0
        )

        location = parsed_result.location
        logger.debug(f"Parsed location: {location}")
        return location

    except Exception as e:
        logger.error(f"Failed to parse location from query: {e}")
        logger.warning("Falling back to 'local' location")
        return "local"


# =============================================================================
# Capability Implementation
# =============================================================================

@capability_node
class CurrentWeatherCapability(BaseCapability):
    """
    Retrieve current weather conditions for supported cities.

    This capability demonstrates the basic pattern for building capabilities:
    extracting inputs from the task, calling external services, and returning
    structured context objects.
    """

    name = "current_weather"
    description = "Get current weather conditions for a location"
    provides = ["CURRENT_WEATHER"]
    requires = []

    async def execute(self) -> Dict[str, Any]:
        """
        Retrieve current weather for the requested location.

        Extracts the location from the user's query, calls the mock weather API,
        and returns a structured CurrentWeatherContext with temperature and conditions.
        """
        # Get unified logger with automatic streaming support
        logger = self.get_logger()

        try:
            # Extract location from user's query
            query = self.get_task_objective()
            location = await _parse_location_from_query(query)

            # Get weather data
            logger.status(f"Getting weather for {location}...")
            weather = weather_api.get_current_weather(location)

            # Create context with the results
            context = CurrentWeatherContext(
                location=weather.location,
                temperature=weather.temperature,
                conditions=weather.conditions,
                timestamp=weather.timestamp
            )

            logger.status(f"Weather retrieved: {location} - {weather.temperature}°C")
            return self.store_output_context(context)

        except Exception as e:
            logger.error(f"Weather retrieval error: {e}")
            raise

    @staticmethod
    def classify_error(exc: Exception, context: dict) -> ErrorClassification:
        """
        Classify errors to guide retry behavior.

        Network errors (ConnectionError, TimeoutError) are marked as RETRIABLE
        so the framework will automatically retry them. All other errors are
        CRITICAL and will fail immediately.
        """
        if isinstance(exc, (ConnectionError, TimeoutError)):
            return ErrorClassification(
                severity=ErrorSeverity.RETRIABLE,
                user_message="Weather service timeout, retrying...",
                metadata={"technical_details": str(exc)}
            )

        return ErrorClassification(
            severity=ErrorSeverity.CRITICAL,
            user_message=f"Weather service error: {str(exc)}",
            metadata={"technical_details": f"Error: {type(exc).__name__}"}
        )

    @staticmethod
    def get_retry_policy() -> Dict[str, Any]:
        """
        Configure retry behavior for weather service failures.

        Uses 3 attempts with 0.5s initial delay and 1.5x exponential backoff.
        This gives quick recovery for brief outages while being respectful
        of the external service.
        """
        return {
            "max_attempts": 3,
            "delay_seconds": 0.5,
            "backoff_factor": 1.5
        }

    def _create_orchestrator_guide(self) -> Optional[OrchestratorGuide]:
        """
        Guide the orchestrator on when and how to use this capability.

        Provides examples showing how to plan weather retrieval steps and
        how to pass the results to the respond capability.
        This guidance enables intelligent workflow planning that optimizes capability
        sequencing, dependency management, and resource utilization.

        The guide includes detailed instructions, practical examples, and success
        criteria that help the orchestration system make informed decisions about
        weather capability integration in complex multi-step workflows.

        Guidance Components:
            - **Usage Instructions**: Clear criteria for when to plan weather retrieval steps
            - **Output Documentation**: Detailed description of generated context types
            - **Location Support**: Explicit documentation of supported cities and fallback behavior
            - **Example Scenarios**: Realistic planning examples with expected outcomes
            - **Success Criteria**: Measurable indicators of successful weather data retrieval

        Planning Integration:
            The orchestrator uses this guidance to:

            1. **Step Planning**: Determine when weather retrieval fits in execution workflows
            2. **Dependency Analysis**: Understand context types provided for downstream capabilities
            3. **Resource Planning**: Estimate execution time and external service dependencies
            4. **Error Handling**: Plan for weather service failures and fallback strategies
            5. **User Experience**: Optimize step sequencing for responsive user interactions

        :return: Complete orchestrator guidance containing instructions, examples,
            and metadata for intelligent planning, or None if guidance is not needed
        :rtype: Optional[OrchestratorGuide]

        .. note::
           The guidance is used during execution planning phase and does not affect
           runtime execution behavior. It serves as metadata for the planning system
           to make informed decisions about capability integration.

        .. warning::
           Guidance should accurately reflect capability behavior and limitations.
           Incorrect guidance can lead to poor planning decisions and execution failures.

        Examples:
            Orchestrator planning integration::

                >>> capability = CurrentWeatherCapability()
                >>> guide = capability._create_orchestrator_guide()
                >>> print(guide.instructions)
                **When to plan "current_weather" steps:**
                - When users ask for current weather conditions
                - For real-time weather information requests
                - When location-specific current conditions are needed
                ...

            Planning example usage::

                >>> example = guide.examples[0]
                >>> print(f"Scenario: {example.scenario_description}")
                Scenario: Getting current weather for a location
                >>> print(f"Expected output: {example.step.expected_output}")
                Expected output: CURRENT_WEATHER

            Integration with planning system::

                >>> # Orchestrator uses guidance during plan generation
                >>> if user_query_mentions_weather():
                ...     weather_guide = get_capability_guide("current_weather")
                ...     if matches_planning_criteria(query, weather_guide.instructions):
                ...         plan.add_step(weather_guide.examples[0].step)

        .. seealso::
           :class:`framework.base.OrchestratorGuide` : Guidance structure and interface
           :class:`framework.base.PlannedStep` : Step structure used in planning examples
           :meth:`_create_classifier_guide` : Classification guidance for capability selection
        """
        # Example 1: Single step weather retrieval
        example_single_step = OrchestratorExample(
            step=PlannedStep(
                context_key="current_weather",
                capability="current_weather",
                task_objective="Get current weather conditions for the specified location",
                expected_output="CURRENT_WEATHER",
                success_criteria="Current weather data retrieved with temperature and conditions",
                inputs=[]
            ),
            scenario_description="Getting current weather for a location",
            notes="Output stored as CURRENT_WEATHER with live weather data."
        )

        # Example 2: Complete workflow with response generation using weather data
        # This example demonstrates proper input linking for multi-step plans
        example_with_response = OrchestratorExample(
            step=PlannedStep(
                context_key="final_response",
                capability="respond",
                task_objective="Inform the user of the current temperature using the weather data",
                expected_output="FINAL_RESPONSE",
                success_criteria="User receives clear response with temperature information",
                inputs=[{
                    "CURRENT_WEATHER": "current_weather"
                }]
            ),
            scenario_description="Complete workflow: weather retrieval followed by response generation",
            notes="""This shows the SECOND step in a two-step plan:
Step 1: current_weather capability (context_key='current_weather') retrieves weather data
Step 2: respond capability uses that data via inputs=[{{ '{{' }}'CURRENT_WEATHER': 'current_weather'{{ '}}' }}]

CRITICAL: The respond step MUST reference the weather data from Step 1 in its inputs list."""
        )

        return OrchestratorGuide(
            instructions=f"""**When to plan "current_weather" steps:**
- When users ask for current weather conditions
- For real-time weather information requests
- When location-specific current conditions are needed

**Output: CURRENT_WEATHER**
- Contains: location, temperature, conditions, timestamp
- Available for immediate display or further analysis

**Location Support:**
- Supports: San Francisco, New York, Prague
- Defaults to "local" weather when no location is specified

**Multi-Step Planning:**
When weather data needs to be communicated to the user, plan TWO steps:
1. current_weather step (retrieves data)
2. respond step with inputs=[{{ '{{' }}'CURRENT_WEATHER': '<weather_step_key>'{{ '}}' }}]
The respond step MUST include the weather data in its inputs list to access the retrieved information.""",
            examples=[example_single_step, example_with_response],
            order=5
        )

    def _create_classifier_guide(self) -> Optional[TaskClassifierGuide]:
        """
        Guide the classifier on when this capability is needed.

        Provides examples of queries that DO and DON'T need weather data.
        This helps the LLM accurately determine when to activate this capability.

            Classification example analysis::

                >>> positive_example = guide.examples[0]
                >>> print(f"Query: {positive_example.query}")
                Query: What's the weather like in San Francisco right now?
                >>> print(f"Result: {positive_example.result}")
                Result: True
                >>> print(f"Reason: {positive_example.reason}")
                Reason: Request asks for current weather conditions in a specific location.

            Integration with classification system::

                >>> # Classifier uses guidance to analyze user queries
                >>> query = "How's the weather today?"
                >>> guide = get_classifier_guide("current_weather")
                >>> should_activate = classifier.analyze_query(
                ...     query, guide.instructions, guide.examples
                ... )
                >>> print(f"Activate weather capability: {should_activate}")
                Activate weather capability: True

        .. seealso::
           :class:`framework.base.TaskClassifierGuide` : Classification guidance structure
           :class:`framework.base.ClassifierExample` : Example structure for training
           :meth:`_create_orchestrator_guide` : Orchestration guidance for planning
        """
        return TaskClassifierGuide(
            instructions="Determine if the task requires current weather information for a specific location.",
            examples=[
                ClassifierExample(
                    query="What's the weather like in San Francisco right now?",
                    result=True,
                    reason="Request asks for current weather conditions in a specific location."
                ),
                ClassifierExample(
                    query="How's the weather today?",
                    result=True,
                    reason="Current weather request, though location may need to be inferred."
                ),
                ClassifierExample(
                    query="What was the weather like last week?",
                    result=False,
                    reason="Request is for historical weather data, not current conditions."
                ),
                ClassifierExample(
                    query="What tools do you have?",
                    result=False,
                    reason="Request is for tool information, not weather."
                ),
                ClassifierExample(
                    query="What's the temperature in New York?",
                    result=True,
                    reason="Temperature is a key component of weather conditions."
                ),
                ClassifierExample(
                    query="Is it rainy in San Francisco right now?",
                    result=True,
                    reason="Rain query relates to current atmospheric conditions."
                ),
                ClassifierExample(
                    query="Should I bring a jacket today?",
                    result=True,
                    reason="Clothing decision depends on current weather/temperature conditions."
                ),
                ClassifierExample(
                    query="Calculate the average of today's temperature readings",
                    result=True,
                    reason="Mathematical calculations on weather metrics require current weather data."
                ),
            ],
            actions_if_true=ClassifierActions()
        )
