<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osprey Debug</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: monospace;
            font-size: 13px;
            line-height: 1.4;
            background: #fff;
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header bar */
        .header {
            padding: 8px 12px;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        .header h1 { font-size: 14px; font-weight: bold; }
        .status { display: flex; align-items: center; gap: 6px; }
        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: #ccc;
        }
        .status-dot.connected { background: #090; }
        .status-dot.executing { background: #f90; }

        /* Controls row */
        .controls {
            padding: 8px 12px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        .query-input {
            flex: 1;
            min-width: 200px;
            padding: 6px 8px;
            border: 1px solid #ccc;
            font-family: inherit;
            font-size: inherit;
        }
        .query-input:focus { outline: 1px solid #666; }
        button {
            padding: 6px 12px;
            border: 1px solid #ccc;
            background: #f5f5f5;
            font-family: inherit;
            font-size: inherit;
            cursor: pointer;
        }
        button:hover { background: #eee; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Search and filters */
        .filters {
            padding: 8px 12px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        .search-input {
            width: 200px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            font-family: inherit;
            font-size: inherit;
        }
        .filter-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .filter-group label { font-size: 12px; color: #666; }
        .filter-group select {
            padding: 4px;
            border: 1px solid #ccc;
            font-family: inherit;
            font-size: 12px;
        }

        /* Event timeline */
        .timeline {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px;
        }
        .event {
            border: 1px solid #ddd;
            margin-bottom: 4px;
        }
        .event-row {
            display: flex;
            gap: 8px;
            padding: 4px 8px;
            cursor: pointer;
            align-items: baseline;
        }
        .event-row:hover { background: #f9f9f9; }
        .event-tag {
            font-size: 11px;
            padding: 1px 4px;
            border: 1px solid #999;
            white-space: nowrap;
        }
        .event-component { color: #666; }
        .event-msg { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .event-time { color: #999; font-size: 11px; }
        .event-details {
            display: none;
            padding: 8px;
            border-top: 1px solid #ddd;
            background: #f9f9f9;
        }
        .event.expanded .event-details { display: block; }
        .event-details pre {
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 12px;
        }
        .details-actions {
            margin-bottom: 8px;
            display: flex;
            gap: 8px;
        }

        /* Footer stats */
        .footer {
            padding: 6px 12px;
            border-top: 1px solid #ddd;
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Osprey Debug</h1>
        <div class="status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Disconnected</span>
        </div>
    </div>

    <div class="controls">
        <input type="text" class="query-input" id="queryInput"
               placeholder="Enter query..." value="What's the weather in San Francisco?">
        <button id="executeBtn" disabled>Execute</button>
        <button id="clearBtn">Clear</button>
        <button id="exportBtn">Export YAML</button>
    </div>

    <div class="filters">
        <input type="text" class="search-input" id="searchInput" placeholder="Search events...">
        <div class="filter-group">
            <label>Type:</label>
            <select id="typeFilter"><option value="">All</option></select>
        </div>
        <div class="filter-group">
            <label>Component:</label>
            <select id="componentFilter"><option value="">All</option></select>
        </div>
    </div>

    <div class="timeline" id="timeline">
        <!-- Events appended here (latest at bottom) -->
    </div>

    <div class="footer">
        <span>Events: <strong id="eventCount">0</strong></span>
        <span>Filtered: <strong id="filteredCount">0</strong></span>
    </div>

    <script>
        // State
        let ws = null;
        let events = [];
        let searchText = '';
        let typeFilter = '';
        let componentFilter = '';

        // DOM
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const queryInput = document.getElementById('queryInput');
        const executeBtn = document.getElementById('executeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const exportBtn = document.getElementById('exportBtn');
        const searchInput = document.getElementById('searchInput');
        const typeFilterEl = document.getElementById('typeFilter');
        const componentFilterEl = document.getElementById('componentFilter');
        const timeline = document.getElementById('timeline');
        const eventCount = document.getElementById('eventCount');
        const filteredCount = document.getElementById('filteredCount');

        // Connect
        function connect() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/ws/events`);

            ws.onopen = () => {
                statusDot.classList.add('connected');
                statusText.textContent = 'Connected';
                executeBtn.disabled = false;
            };
            ws.onclose = () => {
                statusDot.classList.remove('connected', 'executing');
                statusText.textContent = 'Disconnected';
                executeBtn.disabled = true;
                setTimeout(connect, 3000);
            };
            ws.onmessage = (e) => handleEvent(JSON.parse(e.data));
        }

        // Handle event
        function handleEvent(data) {
            events.push(data);
            eventCount.textContent = events.length;
            updateFilterOptions();

            if (data.type === 'execution_started') {
                statusDot.classList.add('executing');
            } else if (data.type === 'execution_completed' || data.type === 'execution_error') {
                statusDot.classList.remove('executing');
            }

            if (matchesFilters(data)) {
                appendEvent(data);
                timeline.scrollTop = timeline.scrollHeight;
            }
            updateFilteredCount();
        }

        // Check filters
        function matchesFilters(data) {
            const json = JSON.stringify(data).toLowerCase();
            if (searchText && !json.includes(searchText.toLowerCase())) return false;
            if (typeFilter && data.type !== typeFilter) return false;
            if (componentFilter && data.component !== componentFilter) return false;
            return true;
        }

        // Append event to timeline
        function appendEvent(data) {
            const div = document.createElement('div');
            div.className = 'event';
            const msg = getMsg(data);
            const time = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : '';
            const json = JSON.stringify(data, null, 2);

            div.innerHTML = `
                <div class="event-row">
                    <span class="event-tag">${data.type || 'unknown'}</span>
                    ${data.component ? `<span class="event-component">[${data.component}]</span>` : ''}
                    <span class="event-msg">${escapeHtml(msg)}</span>
                    <span class="event-time">${time}</span>
                </div>
                <div class="event-details">
                    <div class="details-actions">
                        <button class="copy-btn">Copy JSON</button>
                    </div>
                    <pre>${escapeHtml(json)}</pre>
                </div>
            `;

            div.querySelector('.event-row').onclick = () => div.classList.toggle('expanded');
            div.querySelector('.event-details').onclick = (e) => e.stopPropagation();
            div.querySelector('.copy-btn').onclick = (e) => {
                e.stopPropagation();
                navigator.clipboard.writeText(json);
                e.target.textContent = 'Copied!';
                setTimeout(() => e.target.textContent = 'Copy JSON', 1500);
            };

            timeline.appendChild(div);
        }

        // Get message
        function getMsg(data) {
            if (data.data?.message) return data.data.message;
            if (data.data?.phase) return `Phase: ${data.data.phase}`;
            if (data.data?.capability_name) return data.data.capability_name;
            if (data.message) return data.message;
            if (data.query) return `Query: ${data.query}`;
            if (data.error) return data.error;
            return JSON.stringify(data.data || data).slice(0, 80);
        }

        // Update filter dropdowns
        function updateFilterOptions() {
            const types = [...new Set(events.map(e => e.type).filter(Boolean))].sort();
            const comps = [...new Set(events.map(e => e.component).filter(Boolean))].sort();

            const currentType = typeFilter;
            const currentComp = componentFilter;

            typeFilterEl.innerHTML = '<option value="">All</option>' +
                types.map(t => `<option value="${t}" ${t === currentType ? 'selected' : ''}>${t}</option>`).join('');
            componentFilterEl.innerHTML = '<option value="">All</option>' +
                comps.map(c => `<option value="${c}" ${c === currentComp ? 'selected' : ''}>${c}</option>`).join('');
        }

        // Refresh timeline
        function refreshTimeline() {
            timeline.innerHTML = '';
            events.filter(matchesFilters).forEach(appendEvent);
            updateFilteredCount();
            timeline.scrollTop = timeline.scrollHeight;
        }

        function updateFilteredCount() {
            filteredCount.textContent = events.filter(matchesFilters).length;
        }

        // Execute
        function executeQuery() {
            const q = queryInput.value.trim();
            if (!q || !ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({ action: 'execute', query: q }));
        }

        // Clear
        function clearEvents() {
            events = [];
            timeline.innerHTML = '';
            eventCount.textContent = '0';
            filteredCount.textContent = '0';
            searchText = '';
            typeFilter = '';
            componentFilter = '';
            searchInput.value = '';
            typeFilterEl.innerHTML = '<option value="">All</option>';
            componentFilterEl.innerHTML = '<option value="">All</option>';
        }

        // Export YAML
        function exportYAML() {
            // Simple YAML-like format (proper YAML would need a library)
            const yaml = events.map((e, i) => {
                return `- # Event ${i + 1}\n` +
                    Object.entries(e).map(([k, v]) => {
                        const val = typeof v === 'object' ? JSON.stringify(v) : v;
                        return `  ${k}: ${val}`;
                    }).join('\n');
            }).join('\n\n');

            const blob = new Blob([yaml], { type: 'text/yaml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `osprey-events-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.yaml`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listeners
        executeBtn.onclick = executeQuery;
        clearBtn.onclick = clearEvents;
        exportBtn.onclick = exportYAML;
        queryInput.onkeydown = (e) => { if (e.key === 'Enter') executeQuery(); };
        searchInput.oninput = () => { searchText = searchInput.value; refreshTimeline(); };
        typeFilterEl.onchange = () => { typeFilter = typeFilterEl.value; refreshTimeline(); };
        componentFilterEl.onchange = () => { componentFilter = componentFilterEl.value; refreshTimeline(); };

        // Connect on load
        connect();
    </script>
</body>
</html>
